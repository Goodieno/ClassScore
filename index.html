<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ÌïôÍ∏â Ï†êÏàòÌåê</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* GENERAL */
body { 
  font-family: Arial, sans-serif; 
  padding: 2vw; 
  background: #f0f4f8; 
  font-size: 1.2vw; /* Base responsive font size */
}
h1 { font-size: 3vw; margin-bottom: 1vw; }
h2 { font-size: 2.5vw; margin-bottom: 1vw; }
ul { list-style: none; padding: 0; }
li { margin: 1vw 0; }
button.link-btn { 
  background: none; 
  border: none; 
  color: #2563eb; 
  font-size: 1.5vw; 
  cursor: pointer; 
  padding: 0; 
}
button.link-btn:hover { text-decoration: underline; }

/* LEADER */
.leader-text { 
  margin-left: 0.5vw; 
  font-weight: bold; 
  color: #15803d; 
}
.leader-score { 
  color: #000; 
  margin-left: 0.3vw; 
}

/* GRID */
.grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(25vw, 1fr)); 
  max-width: 1000px; 
  margin: 0 auto; 
  gap: 1vw; 
}
.card { 
  background: #fff; 
  border: 1px solid #ddd; 
  border-radius: 10px; 
  padding: 1vw; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  transition: transform 0.2s ease; 
}
.card:hover { transform: scale(1.02); }

.class-name { 
  font-weight: bold; 
  color: #2563eb; 
  font-size: 1.5vw;
}
.points { 
  font-weight: bold; 
  color: #14532d; 
  float: right; 
  font-size: 1.5vw;
}

/* CONTROLS */
.controls { 
  display: grid; 
  grid-template-columns: 1fr 1fr; 
  gap: 0.5vw; 
  margin-top: 0.8vw; 
}
.controls input { 
  grid-column: span 2; 
  padding: 0.5vw; 
  font-size: 1vw; 
  border-radius: 6px; 
  border: 1px solid #ccc; 
}
.controls button { 
  padding: 0.8vw; 
  border: none; 
  color: #fff; 
  font-weight: bold; 
  border-radius: 6px; 
  cursor: pointer; 
  font-size: 1vw; 
}
.btn-add { background: #16a34a; }
.btn-take { background: #dc2626; }
.btn-undo { 
  grid-column: span 2; 
  background: #6b7280; 
}

/* REASONS */
.reasons-wrapper { 
  margin-top: 0.8vw; 
  max-height: 20vw; 
  overflow-y: auto; 
  border: 1px solid #ddd; 
  padding: 0.8vw; 
  border-radius: 8px; 
  background: #f9fafb; 
}
.reason-entry { 
  font-size: 0.9vw; 
  margin-bottom: 0.5vw; 
  padding-bottom: 0.5vw; 
  border-bottom: 1px dashed #ccc; 
}
.reason-entry:last-child { border-bottom: none; }
.reason-time { 
  font-size: 0.7vw; 
  color: #555; 
}
.reason-add { color: #14532d; font-weight: bold; }
.reason-take { color: #b91c1c; font-weight: bold; }

/* ADMIN */
.admin-link { 
  position: fixed; 
  bottom: 1vw; 
  right: 1vw; 
  opacity: 0.7; 
  z-index: 1000; 
}
.admin-link button { 
  font-size: 0.9vw; 
  color: #555; 
}

/* RESPONSIVE TEXT */
@media (max-width: 768px) {
  body { font-size: 3vw; }
  h1 { font-size: 6vw; }
  h2 { font-size: 5vw; }
  .class-name, .points { font-size: 3.5vw; }
  .controls button { font-size: 3vw; padding: 3vw; }
  .controls input { font-size: 2.5vw; padding: 2vw; }
  .reason-entry { font-size: 2.5vw; }
  .reason-time { font-size: 2vw; }
}
</style>
</head>
<body>

<div id="home">
  <h1>ÌïôÎÖÑ ÏÑ†ÌÉù</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<div class="admin-link">
  <button class="link-btn" id="admin-link">‚öôÔ∏è Admin</button>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2",
  storageBucket: "tally-v-2.appspot.com",
  messagingSenderId: "193194015446",
  appId: "1:193194015446:web:41f010ef36a74df776a777"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let grades = {};

function loadData() {
  db.ref("grades").on("value", snapshot => {
    grades = snapshot.val() || {};
    renderHome();
  });
}

function saveClassPoints(gradeName, className, data) {
  db.ref(`grades/${gradeName}/${className}`).set(data);
}

function renderHome() {
  document.getElementById("view").innerHTML = "";
  document.getElementById("home").style.display = "block";
  const ul = document.getElementById("grade-links");
  ul.innerHTML = "";

  for (const gradeName in grades) {
    const li = document.createElement("li");
    const classes = grades[gradeName];
    const maxPoints = Math.max(...Object.values(classes).map(c => c.points || 0));
    const leaders = Object.entries(classes).filter(([_, c]) => (c.points || 0) === maxPoints && maxPoints > 0);
    let leaderHTML = "";
    if (leaders.length === 1) {
      leaderHTML = `<span class="leader-text">üëë ${leaders[0][0]}<span class="leader-score">(${leaders[0][1].points})</span></span>`;
    } else if (leaders.length > 1) {
      leaderHTML = leaders.map(l => `<span class="leader-text">ü•ä ${l[0]}<span class="leader-score">(${l[1].points})</span></span>`).join("");
    }
    li.innerHTML = `<button class="link-btn" data-grade="${gradeName}">${gradeName}</button> ${leaderHTML}`;
    ul.appendChild(li);
  }
}

function renderGrade(gradeName) {
  document.getElementById("home").style.display = "none";
  const view = document.getElementById("view");
  view.innerHTML = `<button class="link-btn" id="back-home">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button><h2>${gradeName} Ï†êÏàòÌåê</h2><div class="grid"></div>`;
  const grid = view.querySelector(".grid");

  const classes = grades[gradeName];
  for (const className in classes) {
    const data = classes[className];
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div><span class="class-name">${className}</span><span class="points">${data.points || 0}</span></div>
      <div class="controls">
        <input placeholder="Ïù¥Ïú† ÏûÖÎ†•" maxlength="30">
        <button class="btn-add">+2</button>
        <button class="btn-take">-1</button>
        <button class="btn-undo" disabled>‚Ü© Undo</button>
      </div>
      <div class="reasons-wrapper"></div>
    `;
    const input = card.querySelector("input");
    const scoreEl = card.querySelector(".points");
    const history = card.querySelector(".reasons-wrapper");
    const undoBtn = card.querySelector(".btn-undo");
    let lastEntry = null;

    function renderReasons() {
      history.innerHTML = "";
      (data.reasons || []).forEach(r => {
        const div = document.createElement("div");
        div.className = `reason-entry ${r.delta > 0 ? "reason-add" : "reason-take"}`;
        div.innerHTML = `<div>${r.text}</div><div class="reason-time">${r.time}</div>`;
        history.appendChild(div);
      });
      history.scrollTop = history.scrollHeight;
    }

    renderReasons();

    function addReason(delta, label) {
      const text = input.value.trim();
      if (!text) return;
      const entry = { text: `${label}: ${text}`, time: new Date().toLocaleString("ko-KR"), delta };
      data.points = (data.points || 0) + delta;
      data.reasons = data.reasons || [];
      data.reasons.push(entry);
      lastEntry = entry;
      undoBtn.disabled = false;
      scoreEl.textContent = data.points;
      input.value = "";
      renderReasons();
      saveClassPoints(gradeName, className, data);
    }

    card.querySelector(".btn-add").onclick = () => addReason(2, "+2Ï†ê");
    card.querySelector(".btn-take").onclick = () => addReason(-1, "-1Ï†ê");

    undoBtn.onclick = () => {
      if (!lastEntry) return;
      data.points -= lastEntry.delta;
      data.reasons.pop();
      lastEntry = null;
      undoBtn.disabled = true;
      scoreEl.textContent = data.points;
      renderReasons();
      saveClassPoint
