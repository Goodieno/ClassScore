<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í•™ê¸‰ ì ìˆ˜íŒ</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* GENERAL */
body { 
  font-family: Arial, sans-serif; 
  padding: 2vw; 
  background: #f0f4f8; 
  font-size: clamp(12px, 1.2vw, 20px); /* dynamically scales */
}
h1 { font-size: clamp(24px, 4vw, 48px); margin-bottom: 1vw; }
h2 { font-size: clamp(20px, 3vw, 36px); margin-bottom: 1vw; }
ul { list-style: none; padding: 0; }
li { margin: 1vw 0; }
button.link-btn { 
  background: none; 
  border: none; 
  color: #2563eb; 
  font-size: clamp(16px, 1.5vw, 24px); 
  cursor: pointer; 
  padding: 0; 
}
button.link-btn:hover { text-decoration: underline; }

/* LEADER */
.leader-text { 
  margin-left: 0.5vw; 
  font-weight: bold; 
  color: #15803d; 
}
.leader-score { 
  color: #000; 
  margin-left: 0.3vw; 
}

/* GRID */
.grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(clamp(220px,25%,300px), 1fr)); 
  max-width: 1200px; 
  margin: 0 auto; 
  gap: clamp(10px, 1vw, 20px); 
}
.card { 
  background: #fff; 
  border: 1px solid #ddd; 
  border-radius: 10px; 
  padding: clamp(10px,1vw,20px); 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  transition: transform 0.2s ease; 
}
.card:hover { transform: scale(1.02); }

.class-name { 
  font-weight: bold; 
  color: #2563eb; 
  font-size: clamp(16px,1.5vw,24px);
}
.points { 
  font-weight: bold; 
  color: #14532d; 
  float: right; 
  font-size: clamp(16px,1.5vw,24px);
}

/* CONTROLS */
.controls { 
  display: grid; 
  grid-template-columns: 1fr 1fr; 
  gap: clamp(5px,0.5vw,10px); 
  margin-top: clamp(5px,0.8vw,10px); 
}
.controls input { 
  grid-column: span 2; 
  padding: clamp(5px,0.5vw,10px); 
  font-size: clamp(14px,1vw,18px); 
  border-radius: 6px; 
  border: 1px solid #ccc; 
}
.controls button { 
  padding: clamp(6px,0.8vw,12px); 
  border: none; 
  color: #fff; 
  font-weight: bold; 
  border-radius: 6px; 
  cursor: pointer; 
  font-size: clamp(14px,1vw,18px);
}
.btn-add { background: #16a34a; }
.btn-take { background: #dc2626; }
.btn-undo { 
  grid-column: span 2; 
  background: #6b7280; 
}

/* REASONS */
.reasons-wrapper { 
  margin-top: clamp(5px,0.8vw,10px); 
  max-height: clamp(120px,20vw,300px); 
  overflow-y: auto; 
  border: 1px solid #ddd; 
  padding: clamp(5px,0.8vw,10px); 
  border-radius: 8px; 
  background: #f9fafb; 
}
.reason-entry { 
  font-size: clamp(12px,0.9vw,16px); 
  margin-bottom: clamp(3px,0.5vw,6px); 
  padding-bottom: clamp(3px,0.5vw,6px); 
  border-bottom: 1px dashed #ccc; 
}
.reason-entry:last-child { border-bottom: none; }
.reason-time { 
  font-size: clamp(10px,0.7vw,14px); 
  color: #555; 
}
.reason-add { color: #14532d; font-weight: bold; }
.reason-take { color: #b91c1c; font-weight: bold; }

/* ADMIN */
.admin-link { 
  position: fixed; 
  bottom: 1vw; 
  right: 1vw; 
  opacity: 0.7; 
  z-index: 1000; 
}
.admin-link button { 
  font-size: clamp(12px,0.9vw,16px); 
  color: #555; 
}
</style>
</head>
<body>

<div id="home">
  <h1>í•™ë…„ ì„ íƒ</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<div class="admin-link">
  <button class="link-btn" id="admin-link">âš™ï¸ Admin</button>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2",
  storageBucket: "tally-v-2.appspot.com",
  messagingSenderId: "193194015446",
  appId: "1:193194015446:web:41f010ef36a74df776a777"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let grades = {};

function loadData() {
  db.ref("grades").on("value", snapshot => {
    grades = snapshot.val() || {};
    renderHome();
  });
}

function saveClassPoints(gradeName, className, data) {
  db.ref(`grades/${gradeName}/${className}`).set(data);
}

function renderHome() {
  document.getElementById("view").innerHTML = "";
  document.getElementById("home").style.display = "block";
  const ul = document.getElementById("grade-links");
  ul.innerHTML = "";

  for (const gradeName in grades) {
    const li = document.createElement("li");
    const classes = grades[gradeName];
    const maxPoints = Math.max(...Object.values(classes).map(c => c.points || 0));
    const leaders = Object.entries(classes).filter(([_, c]) => (c.points || 0) === maxPoints && maxPoints > 0);
    let leaderHTML = "";
    if (leaders.length === 1) {
      leaderHTML = `<span class="leader-text">ğŸ‘‘ ${leaders[0][0]}<span class="leader-score">(${leaders[0][1].points})</span></span>`;
    } else if (leaders.length > 1) {
      leaderHTML = leaders.map(l => `<span class="leader-text">ğŸ¥Š ${l[0]}<span class="leader-score">(${l[1].points})</span></span>`).join("");
    }
    li.innerHTML = `<button class="link-btn" data-grade="${gradeName}">${gradeName}</button> ${leaderHTML}`;
    ul.appendChild(li);
  }
}

function renderGrade(gradeName) {
  document.getElementById("home").style.display = "none";
  const view = document.getElementById("view");
  view.innerHTML = `<button class="link-btn" id="back-home">â† ëŒì•„ê°€ê¸°</button><h2>${gradeName} ì ìˆ˜íŒ</h2><div class="grid"></div>`;
  const grid = view.querySelector(".grid");

  const classes = grades[gradeName];
  for (const className in classes) {
    const data = classes[className];
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div><span class="class-name">${className}</span><span class="points">${data.points || 0}</span></div>
      <div class="controls">
        <input placeholder="ì´ìœ  ì…ë ¥" maxlength="30">
        <button class="btn-add">+2</button>
        <button class="btn-take">-1</button>
        <button class="btn-undo" disabled>â†© Undo</button>
      </div>
      <div class="reasons-wrapper"></div>
    `;
    const input = card.querySelector("input");
    const scoreEl = card.querySelector(".points");
    const history = card.querySelector(".reasons-wrapper");
    const undoBtn = card.querySelector(".btn-undo");
    let lastEntry = null;

    function renderReasons() {
      history.innerHTML = "";
      (data.reasons || []).forEach(r => {
        const div = document.createElement("div");
        div.className = `reason-entry ${r.delta > 0 ? "reason-add" : "reason-take"}`;
        div.innerHTML = `<div>${r.text}</div><div class="reason-time">${r.time}</div>`;
        history.appendChild(div);
      });
      history.scrollTop = history.scrollHeight;
    }

    renderReasons();

    function addReason(delta, label) {
      const text = input.value.trim();
      if (!text) return;
      const entry = { text: `${label}: ${text}`, time: new Date().toLocaleString("ko-KR"), delta };
      data.points = (data.points || 0) + delta;
      data.reasons = data.reasons || [];
      data.reasons.push(entry);
      lastEntry = entry;
      undoBtn.disabled = false;
      scoreEl.textContent = data.points;
      input.value = "";
      renderReasons();
      saveClassPoints(gradeName, className, data);
    }

    card.querySelector(".btn-add").onclick = () => addReason(2, "+2ì ");
    card.querySelector(".btn-take").onclick = () => addReason(-1, "-1ì ");

    undoBtn.onclick = () => {
      if (!lastEntry) return;
      data.points -= lastEntry.delta;
      data.reasons.pop();
      lastEntry = null;
      undoBtn.disabled = true;
      scoreEl.textContent = data.points;
      renderReasons();
      saveClassPoints(gradeName, className, data);
    };

    grid.appendChild(card);
  }
}

function checkAdminPassword() {
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if (pw === "delete") renderAdmin();
  else if (pw !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
}

function renderAdmin() {
  document.getElementById("home").style.display = "none";
  const view = document.getElementById("view");
  view.innerHTML = `<button class="link-btn" id="back-home">â† ëŒì•„ê°€ê¸°</button><h2>ê´€ë¦¬ì íŒ¨ë„</h2><p>í•™ë…„ë³„ ì ìˆ˜ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
  for (const gradeName in grades) {
    const btn = document.createElement("button");
    btn.className = "link-btn";
    btn.textContent = `${gradeName} ì ìˆ˜ ì´ˆê¸°í™”`;
    btn.onclick = () => {
      if (!confirm(`${gradeName} ì ìˆ˜ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?`)) return;
      const classes = grades[gradeName];
      for (const className in classes) {
        classes[className].points = 0;
        classes[className].reasons = [];
        saveClassPoints(gradeName, className, classes[className]);
      }
      alert(`${gradeName} ì ìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`); renderHome();
    };
    view.appendChild(btn);
    view.appendChild(document.createElement("br"));
  }
}

document.addEventListener("click", e => {
  if (e.target.dataset.grade) renderGrade(e.target.dataset.grade);
  if (e.target.id === "back-home") renderHome();
  if (e.target.id === "admin-link") checkAdminPassword();
});

loadData();
</script>
</body>
</html>
